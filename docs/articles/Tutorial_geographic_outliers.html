<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial - Identifying geographic outliers • CoordinateCleaner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial - Identifying geographic outliers">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CoordinateCleaner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Background_comparison_other_software.html">Background - Comparison of CoordinateCleaner to other tools</a>
    </li>
    <li>
      <a href="../articles/Background_dataset_level_cleaning.html">Background - Dataset-level cleaning</a>
    </li>
    <li>
      <a href="../articles/Background_the_institutions_database.html">Background - The institutions database</a>
    </li>
    <li>
      <a href="../articles/Quickstart_clean_fossils.html">Quick start - Problematic fossils</a>
    </li>
    <li>
      <a href="../articles/Quickstart_Flagging_problematic_coordinates_in_a_nutshell.html">Quick start - Flagging problematic coordinates in a nutshell</a>
    </li>
    <li>
      <a href="../articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html">Tutorial - Cleaning GBIF data for the use in biogeography</a>
    </li>
    <li>
      <a href="../articles/Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner.html">Tutorial - Cleaning fossil data for the use in biogeography and palaeontology</a>
    </li>
    <li>
      <a href="../articles/Tutorial_geographic_outliers.html">Tutorial - Identifying geographic outliers</a>
    </li>
    <li>
      <a href="../articles/Tutorial_Using_custom_gazetteers.html">Tutorial - Using customized gazetteers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Tutorial - Identifying geographic outliers</h1>
            
      
      
      <div class="hidden name"><code>Tutorial_geographic_outliers.Rmd</code></div>

    </div>

    
    
<div id="the-problem-of-geographic-outliers" class="section level1">
<h1 class="hasAnchor">
<a href="#the-problem-of-geographic-outliers" class="anchor"></a>The problem of geographic outliers</h1>
<p>Isolated occurrence records, distant to all other recordings of a taxon–i.e. geographic outliers–often are erroneous or problematic, because might present 1) data entry errors such as switched coordinates or switched decimal signs, 2) individuals in horticulture or captivity far from natural conditions, 3) alien records outside the natural range of the species, or 4) “freak” individuals that are remnants of historical contingencies. For many analyses such records are undesirable and need to be removed. However, the automatic treatment of such records is difficult, because records from cases 3) and 4) might be relevant for some analyses, distance-based outlier detection is a “majority vote” and hence susceptible to uneven sampling, and because some species (albeit few in our experience) might have geographically disjunct distributions (for instance on oceanic islands) prone to create false positives. Furthermore, it is generally difficult to define where a species range ends and when a record should be considered and outlier. Environmental factors can be used to inform a decision on geographic outliers, however, if records are used for environmental based distribution modelling after cleaning the is a risk of circularity.</p>
<p><em>CoordinateCleaner</em> implements the <code>cc_outl</code> test to automatically flag outlier records based on geographic position by using interquartile range outlier detection (<span class="math inline">\(x &gt; IQR(x) + Q_{75} * mltpl\)</span>) on a distance matrix of all records of a species. In our experience this test can largely improve datasets and is unproblematic for most species, but needs more careful thought than the other tests implemented in <em>CoordinateCleaner</em>. The default settings of the test are conservative in flagging records, but if peripheral or satellite distributions are common in a dataset and relevant to the analyses outcome, we strongly recommend to inspect flagged records carefully.</p>
<p>In this tutorial we illustrate the potential and caveats of <code>cc_outl</code> using two boundary case examples of species with strong sampling bias– the Red squirrel and the Eurasian lynx. In the end, we present <code>cc_iucn</code> as an alternative for outlier detection for datasets with large ranges and strong sampling bias.</p>
</div>
<div id="the-case-of-the-european-lynx" class="section level1">
<h1 class="hasAnchor">
<a href="#the-case-of-the-european-lynx" class="anchor"></a>1. The case of the European lynx</h1>
<p>The Eurasian lynx (<em>Lynx lynx</em>) is a wide-spread Eurasian carnivore. The Global Biodiversity Information Facility (www.gbif.org) comprises more than 24774 records for this species, the vast majority in Europe, few records from Asia, and some records from North America and South America. While the European and Asian records correspond to the recent natural range of the species (compare for instance <a href="http://www.iucnredlist.org/details/12519/0">here</a>), the American records are doubtful and might correspond to swapped coordinates, individuals in captivity or misidentification of the Canada lynx (<em>Lynx canadensis</em>). The Eurasian lynx is an extreme case for outlier detection, because it includes true erroneous outliers (in the Americas), but also very isolated but potentially valid records (in northern China). <code>cc_outl</code> can still help to improve the data set. Since this is a large dataset, the test will automatically use a raster-based distance approximation for the calculation of the distance matrix, as for all species with more than 10,000 records.</p>
<div id="testing-for-geographic-outliers-defaults" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-for-geographic-outliers-defaults" class="anchor"></a>Testing for geographic outliers, defaults</h2>
<p>We will first download occurrence records for <em>Lynx lynx</em> from www.gbif.org using the rgbif package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load data from GBIF</span>
lnx &lt;-<span class="st"> </span>rgbif<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rgbif/topics/occ_search">occ_search</a></span>(<span class="dt">scientificName =</span> <span class="st">"Lynx lynx"</span>, <span class="dt">limit =</span> <span class="dv">200000</span>,
         <span class="dt">hasCoordinate =</span> T, <span class="dt">return =</span> <span class="st">"data"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="dt">species =</span> key, <span class="dt">decimallongitude =</span> decimalLongitude, 
         <span class="dt">decimallatitude =</span> decimalLatitude, countrycode)</code></pre></div>
<p>You can then run the default <code>cc_outl</code> test.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run basic coordinate cleaning</span>
flags &lt;-<span class="st"> </span><span class="kw"><a href="../reference/clean_coordinates.html">clean_coordinates</a></span>(<span class="dt">x =</span> lnx, <span class="dt">tests =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"capitals"</span>,
  <span class="st">"centroids"</span>, <span class="st">"equal"</span>, <span class="st">"gbif"</span>, <span class="st">"institutions"</span>,<span class="st">"seas"</span>,<span class="st">"zeros"</span>))
## OGR data source with driver: ESRI Shapefile 
## Source: "C:\Users\az64mycy\AppData\Local\Temp\Rtmp6vwHAo", layer: "ne_50m_land"
## with 1420 features
## It has 3 fields
## Integer64 fields read as strings:  scalerank

lnx &lt;-<span class="st"> </span>lnx[flags<span class="op">$</span>.summary,]

<span class="co"># Default outlier detection</span>
outl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_outl.html">cc_outl</a></span>(lnx, <span class="dt">value =</span> <span class="st">"flagged"</span>)

plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(lnx, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>outl))

<span class="co"># visualize occurrence records</span>
<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>The default settings of the outlier test flagged 17 outliers out of 23980 records. A comparison with the natural range of the species shows that the test performed quite well with the default settings: all American records were flagged correctly as outliers and most Eurasian records were not flagged. However there are some potential issues, since three isolated records in Asia where also flagged as potential outliers, although they likely are valid records. In this case the isolated position of those records is not an error, but probably rather due the extremely low sampling and data availability across large parts of Asia. <code>cc_outl</code> offers two options to improve the results 1) tweaking test sensitivity and 2) accounting for sampling intensity.</p>
</div>
<div id="tweaking-test-sensitivity" class="section level2">
<h2 class="hasAnchor">
<a href="#tweaking-test-sensitivity" class="anchor"></a>Tweaking test sensitivity</h2>
<p>We can make the outlier detection more conservative using the <code>mltpl</code> argument of <code>cc_outl</code>. We’ll increase mltpl to 6, meaning that the mean distance of a record to all other records must be more than 6 times the interquantile range of the mean distance of all points.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">outl_<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_outl.html">cc_outl</a></span>(lnx, <span class="dt">value =</span> <span class="st">"flagged"</span>, <span class="dt">mltpl =</span> <span class="dv">6</span>)

plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(lnx, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>outl_<span class="dv">6</span>))

<span class="co"># visualize occurrence records</span>
<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>This improved the results and the dataset might be acceptable for most analyses. Tweaking the test sensitivity is an easy measure and only requires a general idea of how disjunct sampling in a dataset is and how important falsely flagged records (false positives for the test) compared to falsely retained records (false negatives for the test) are for downstream analyses. Only the two very isolated records in eastern Asia remain problematic. These records represent an extreme case, due to the rare combination of the extremely large distribution range of the species and the extremely sparse sampling over huge areas.</p>
</div>
<div id="correcting-for-sampling-intensity" class="section level2">
<h2 class="hasAnchor">
<a href="#correcting-for-sampling-intensity" class="anchor"></a>Correcting for sampling intensity</h2>
<p><code>cc_outl</code> enables to account for uneven sampling, on a country level using the <code>sampling_thresh</code> argument. Based on the assumption that in areas (i.e. countries) of high sampling species are more likely to be recorded and hence the distance of any correct occurrence record to the next record of the same species will be small, <code>sampling_thresh</code> can avoid the flagging of records from countries with very low general availability of occurrence records. If <code>sampling_thresh</code> is larger than zero, <code>cc_outl</code> uses the density of biological occurrence records available for a country from the Global Biodiversity Information Facility as proxy of sampling in this country. Based on the statistical distribution of the record density across all countries, flagged records from countries in the lower <code>sampling_thres</code> percentile, are never considered outliers. For instance, when <code>sampling_thresh</code> equals 0.25, records from the 25% least densely sampled countries cannot be flagged as outliers.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run outlier test</span>
outl_samp&lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_outl.html">cc_outl</a></span>(lnx, <span class="dt">value =</span> <span class="st">"flagged"</span>, <span class="dt">mltpl =</span> <span class="dv">6</span>,  <span class="dt">sampling_thresh =</span> <span class="fl">0.25</span>)

<span class="co"># visualize occurrence records</span>
plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(lnx, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>outl_samp))

<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Correcting for sampling the records in Eastern China are now correctly assigned and the entire natural range of <em>Lynx lynx</em> is included in the dataset. However a record in Bolivia is now falsely included in the dataset. The extreme case of the lynx illustrates inherent limits of automated geographic outlier testing, since a true error (the record in Bolivia) is less distant than some of the correct records (in northern China) under similar sampling conditions.</p>
</div>
</div>
<div id="the-case-of-the-red-squirrel" class="section level1">
<h1 class="hasAnchor">
<a href="#the-case-of-the-red-squirrel" class="anchor"></a>2. The case of the red squirrel</h1>
<p>The Red squirrel (<em>Sciurus vulgaris</em>) is widespread throughout Eurasia and has 214729 records in the Global Biodiversity Information Facility (www.gbif.org). The sampling in the natural range is highly clustered in Europe with few records across Asia. Additionally, the dataset includes multiple records that are likely erroneous in the Americas and South Africa. The biased sampling effort towards Europe, together with the large distribution range of the species make the use of geographic outlier detection for data cleaning challenging. Still, <code>cc_outl</code> can help to improve the data set. Since this is a large dataset, the test will automatically use a raster-based distance approximation for the calculation of the distance matrix, as for all species with more than 10,000 records.</p>
<p>Again, we will download occurrence records from www.gbif.org and then run <code>cc_outl</code> with default settings.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load data from GBIF</span>
squ &lt;-<span class="st"> </span>rgbif<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rgbif/topics/occ_search">occ_search</a></span>(<span class="dt">scientificName =</span> <span class="st">"Lynx lynx"</span>, <span class="dt">limit =</span> <span class="dv">200000</span>,
         <span class="dt">hasCoordinate =</span> T, <span class="dt">return =</span> <span class="st">"data"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="dt">species =</span> key, decimallongitude, decimallatitude, countrycode,
         <span class="dt">hasCoordinate =</span> T)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run basic coordinate cleaning</span>
flags &lt;-<span class="st"> </span><span class="kw"><a href="../reference/clean_coordinates.html">clean_coordinates</a></span>(<span class="dt">x =</span> squ, <span class="dt">tests =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"capitals"</span>,
  <span class="st">"centroids"</span>, <span class="st">"equal"</span>, <span class="st">"gbif"</span>, <span class="st">"institutions"</span>,<span class="st">"seas"</span>,<span class="st">"zeros"</span>))
## OGR data source with driver: ESRI Shapefile 
## Source: "C:\Users\az64mycy\AppData\Local\Temp\Rtmp6vwHAo", layer: "ne_50m_land"
## with 1420 features
## It has 3 fields
## Integer64 fields read as strings:  scalerank

squ &lt;-<span class="st"> </span>squ[flags<span class="op">$</span>.summary,]

<span class="co"># Default outlier detection</span>
outl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_outl.html">cc_outl</a></span>(squ, <span class="dt">value =</span> <span class="st">"flagged"</span>)

plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(squ, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>outl))

<span class="co"># visualize occurrence records</span>
<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The default test flagged 21504 of 193225 records. A comparison with the natural range shows that all erroneous records in the Americas and South Africa where identified correctly. Unfortunately the strong sampling bias towards Europe has also let to a flagging of potentially correct East Asian records. We will again use the sampling thresh argument to address this and avoid the false flagging of records in Eastern Asia.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run outlier test</span>
outl_samp&lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_outl.html">cc_outl</a></span>(squ, <span class="dt">value =</span> <span class="st">"flagged"</span>, <span class="dt">sampling_thresh =</span> <span class="fl">0.25</span>)

<span class="co"># visualize occurrence records</span>
plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(squ, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>outl_samp))

<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>This improved the results significantly and the cleaned dataset seems a good representation of the natural distribution of <em>Sciurus vulgaris</em>. However, similar to the example of the Eurasian lynx, the result is not perfect, since the records in Korea and Japan are flagged as outliers. Hence additional or alternative data cleaning methods might be necessary.</p>
</div>
<div id="natural-ranges-instead-of-outlier-detection" class="section level1">
<h1 class="hasAnchor">
<a href="#natural-ranges-instead-of-outlier-detection" class="anchor"></a>3. Natural ranges instead of outlier detection</h1>
<p>The examples above showed the potential and caveats of <code>cc_outl</code>. If the inclusion of all records from the natural range, also in the periphery (as for the most eastern Asian records for the squirrel) and the exclusion of all records outside there of is crucial for downstream analyses and no reasonable balance between Type I and Type II error can be found, other approaches to identify “outlier” records might be more appropriate. If additional information on species natural ranges is available, for instance from the [International Union for the Conservation of Nature] (<a href="http://www.iucnredlist.org/technical-documents/spatial-data" class="uri">http://www.iucnredlist.org/technical-documents/spatial-data</a>) (as is the case for all amphibians, birds, mammals, and reptiles), you can use the <code>cc_iucn</code> function of <em>CoordinateCleaner</em> to exclude records outside this range. <code>cc_iucn</code> directly accepts the IUCN format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#load the IUCN range for the Red squirrel. </span>
<span class="co">#These are not provided with CoordinateCleaner and </span>
<span class="co">#need to be downloaded seperately from www.iucn.org</span>
sq_range &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">"inst"</span>, <span class="dt">layer =</span> <span class="st">"species_20025"</span>)
## OGR data source with driver: ESRI Shapefile 
## Source: "C:\Users\az64mycy\Dropbox (iDiv)\research_projects\29_CoordinateCleaner\CoordinateCleaner\vignettes\inst", layer: "species_20025"
## with 2 features
## It has 22 fields
sq_range<span class="op">@</span>data<span class="op">$</span>species &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(squ<span class="op">$</span>species) <span class="co">#replace species name by GBIF ID to synchronize betwee records and range polygon</span>

<span class="co"># run natural range test</span>
rang &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_iucn.html">cc_iucn</a></span>(<span class="dt">x =</span> squ, <span class="dt">range =</span> sq_range, <span class="dt">value =</span> <span class="st">"flagged"</span>)

<span class="co"># plot results</span>
plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(squ, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>rang))

nat_range &lt;-<span class="st"> </span><span class="kw">fortify</span>(sq_range)

<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> nat_range, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group), <span class="dt">fill =</span> <span class="st">"green"</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">col =</span> <span class="st">"grey50"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>If no such information is available, ranges can be generated ad-hoc. <code>cc_iucn</code> can be applied for multiple species, assuming a <code>SpatialPolygonDataFrame</code> similar in structure to the data provided by the IUCN.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create custom range polygon for the lynx</span>
## define the polygon shape
lx_range &lt;-<span class="st"> </span><span class="kw">Polygon</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">10</span>, <span class="op">-</span><span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">170</span>, <span class="dv">138</span>, <span class="dv">83</span>, <span class="dv">36</span>, <span class="dv">14</span>, <span class="op">-</span><span class="dv">10</span>), 
                       <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">35</span>, <span class="dv">67</span>, <span class="dv">80</span>, <span class="dv">69</span>, <span class="dv">32</span>, <span class="dv">21</span>, <span class="dv">25</span>, <span class="dv">35</span>, <span class="dv">35</span>)))
lx_range &lt;-<span class="st"> </span><span class="kw">Polygons</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(lx_range), <span class="dt">ID =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"A"</span>))

## define projection
wgs84 &lt;-<span class="st"> "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"</span>
lx_range &lt;-<span class="st"> </span><span class="kw">SpatialPolygons</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(lx_range), <span class="dt">proj4string =</span> <span class="kw">CRS</span>(wgs84))

## creat dataset in same format as for the quirrel; species = species name, in this case the GBIF ID

df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">species =</span> <span class="dv">2435240</span>, <span class="dt">row.names =</span> <span class="st">"A"</span>)
lx_range &lt;-<span class="st"> </span><span class="kw">SpatialPolygonsDataFrame</span>(lx_range, <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(df))

<span class="co"># run natural range test</span>
rang &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_iucn.html">cc_iucn</a></span>(<span class="dt">x =</span> lnx, <span class="dt">range =</span> lx_range, <span class="dt">value =</span> <span class="st">"flagged"</span>)

<span class="co"># plot results</span>
plo &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(lnx, <span class="dt">outlier =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="op">!</span>rang))

nat_range &lt;-<span class="st"> </span><span class="kw">fortify</span>(lx_range)

<span class="kw">ggplot</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">borders</span>(<span class="dt">fill =</span> <span class="st">"grey60"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> nat_range, <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat), <span class="dt">fill =</span> <span class="st">"green"</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">col =</span> <span class="st">"grey50"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> plo, 
             <span class="kw">aes</span>(<span class="dt">x =</span> decimallongitude, <span class="dt">y =</span> decimallatitude, <span class="dt">col =</span> outlier))<span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_viridis</span>(<span class="dt">discrete =</span> T, <span class="dt">name =</span> <span class="st">"Flagged outlier"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">coord_fixed</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()<span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</code></pre></div>
<p><img src="Tutorial_geographic_outliers_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p><code>cc_iucn</code> supports occurrence record datasets and range polygons containing multiple species, so that for instance a set of occurrence records from all mammals can clean using the IUCN shape file containing all mammal natural ranges. IUCN and custom polygons can also be combined, if their structure is adapted</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## adapt the structure of the lynx polygon
lx_range<span class="op">@</span>data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(sq_range<span class="op">@</span>data))), <span class="dt">row.names =</span> <span class="st">"A"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(lx_range<span class="op">@</span>data) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(sq_range<span class="op">@</span>data)

<span class="co"># Combine ranges</span>
nat_range &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(sq_range, lx_range) 

<span class="co"># Combine records</span>
dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(squ, lnx)

<span class="co"># run natural range test</span>
rang &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_iucn.html">cc_iucn</a></span>(<span class="dt">x =</span> dat, <span class="dt">range =</span> nat_range, <span class="dt">value =</span> <span class="st">"flagged"</span>)</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#the-problem-of-geographic-outliers">The problem of geographic outliers</a></li>
      <li>
<a href="#the-case-of-the-european-lynx">1. The case of the European lynx</a><ul class="nav nav-pills nav-stacked">
<li><a href="#testing-for-geographic-outliers-defaults">Testing for geographic outliers, defaults</a></li>
      <li><a href="#tweaking-test-sensitivity">Tweaking test sensitivity</a></li>
      <li><a href="#correcting-for-sampling-intensity">Correcting for sampling intensity</a></li>
      </ul>
</li>
      <li><a href="#the-case-of-the-red-squirrel">2. The case of the red squirrel</a></li>
      <li><a href="#natural-ranges-instead-of-outlier-detection">3. Natural ranges instead of outlier detection</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Alexander Zizka.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
